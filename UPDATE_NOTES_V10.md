# 公司管理系统 v10 更新说明

## 更新日期
2025年12月17日

## 主要更新内容

### 1. 数据备份功能完善

本次更新对服务器配置界面中的数据备份功能进行了全面完善，新增了自动备份功能，并优化了手动备份和数据恢复功能。

#### 自动备份功能
自动备份功能允许系统每20分钟自动创建一次数据备份，新的备份会覆盖前一次的自动备份，避免占用过多存储空间。自动备份包含服务器配置数据和管理系统数据（用户、项目、工序、日报等）。

使用方法：
1. 进入服务器配置界面（/admin）
2. 点击"数据备份"标签页
3. 勾选"启用自动备份"选项
4. 系统将立即执行一次备份，之后每20分钟自动备份一次
5. 可在"上次自动备份时间"处查看最近一次自动备份的时间

#### 手动备份功能
手动备份功能允许用户随时创建数据备份，可选择是否同时备份服务器配置文件。

使用方法：
1. 进入服务器配置界面（/admin）
2. 点击"数据备份"标签页
3. 根据需要勾选"同时备份服务器配置"选项
4. 点击"立即创建备份"按钮

#### 数据恢复功能
数据恢复功能允许用户从备份中恢复数据。恢复前系统会自动创建当前数据的备份，确保数据安全。恢复后数据会自动同步到管理系统前端。

使用方法：
1. 在备份列表中找到要恢复的备份
2. 点击对应的"恢复"按钮
3. 确认恢复操作
4. 点击"确定"后会自动打开管理系统页面，数据会自动同步
5. 如果备份包含配置文件，建议恢复后重启服务器

### 2. 数据同步机制

本次更新新增了前后端数据同步机制，确保管理系统数据（项目、工序、日报）能够正确备份和恢复。

#### 数据同步流程
- **创建/修改/删除操作**：前端执行操作后，数据会自动同步到服务器端
- **页面加载**：前端页面加载时会检查服务器端数据，如有更新则自动同步
- **数据恢复**：恢复备份后，前端会自动从服务器获取最新数据

#### 新增API
| 接口 | 方法 | 说明 |
|-----|------|------|
| /api/sync-projects | POST | 同步项目数据到服务器 |
| /api/sync-processes | POST | 同步工序数据到服务器 |
| /api/sync-daily-reports | POST | 同步日报数据到服务器 |
| /api/sync-data | GET | 获取服务器端所有数据 |

### 3. 仪表盘和数据报表修复

修复了仪表盘（Dashboard）和数据报表（Reports）页面的显示问题。之前由于数据服务函数返回的属性名与组件使用的属性名不匹配，导致统计数据无法正确显示。

修复内容：
- 修正了 `getProjectStats()` 函数返回的属性名
- 添加了 `total`、`completed`、`inProgress`、`planning`、`review`、`averageProgress` 等属性
- 保留了旧属性名以保持向后兼容性

## 文件变更列表

| 文件路径 | 变更类型 | 说明 |
|---------|---------|------|
| server/index.cjs | 修改 | 添加自动备份API，完善备份恢复功能，添加数据同步API |
| server/config-ui.html | 修改 | 添加自动备份界面，完善备份列表显示，添加恢复后自动同步 |
| src/services/data.ts | 修改 | 修复getProjectStats函数，添加数据同步功能 |

## 备份文件结构

```
server/data/backups/
├── backup_YYYY-MM-DDTHH-mm-ss-sssZ/  # 手动备份
│   ├── users.json
│   ├── projects.json
│   ├── processes.json
│   ├── daily-reports.json
│   └── config.json (可选)
├── auto_backup/                       # 自动备份（每20分钟覆盖）
└── auto_before_restore_xxx/           # 恢复前自动备份
```

## 使用建议

1. **定期备份**：建议开启自动备份功能，同时定期手动创建备份以防数据丢失
2. **重要操作前备份**：在进行重要数据修改前，建议先手动创建一次备份
3. **恢复后重启**：如果恢复的备份包含配置文件，建议重启服务器以应用新配置
4. **多设备使用**：数据存储在服务器端，多设备可共享数据

## 兼容性说明

本次更新保持了与之前版本的完全兼容，旧版本创建的备份可以正常恢复。
